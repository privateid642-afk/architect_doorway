<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Architect Doorway</title>
    <link rel="stylesheet" href="/index.css?v=1" />

    <!-- ===================== TEMP PASSWORD GATE =====================
      • Replace entire file with this.
      • Default credentials: user: test | pass: Test-Arch-25
      • Session-based. Localhost bypass.
      • Overlay stays until app mounts; errors surface on-screen.
    ================================================================= -->
    <style>
      html, body { height: 100%; margin: 0; background:#0b0b0b; color:#eaeaea; }
      #auth-overlay {
        position: fixed; inset: 0; display: none;
        align-items: center; justify-content: center; gap: 16px;
        background: rgba(0,0,0,.72); z-index: 2147483647;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        text-align: center; padding: 16px;
      }
      #auth-card {
        width: min(92vw, 420px); padding: 22px 22px 18px; border-radius: 14px;
        background: #121212; color: #eaeaea; box-shadow: 0 10px 30px rgba(0,0,0,.45);
      }
      #auth-card h2 { margin: 0 0 6px; font-size: 20px; font-weight: 700; }
      #auth-card p  { margin: 0 0 14px; font-size: 13px; color: #bdbdbd; }
      .auth-row { display: grid; gap: 10px; margin-top: 8px; }
      .auth-input {
        width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #2a2a2a;
        background:#1a1a1a; color:#f1f1f1; outline: none;
      }
      .auth-btn {
        width: 100%; padding: 11px 12px; border: 0; border-radius: 10px;
        background: #16a34a; color: white; font-weight: 700; cursor: pointer;
      }
      .auth-btn:disabled { opacity: .6; cursor: not-allowed; }
      .auth-err { margin-top: 6px; color: #ff6b6b; font-size: 12px; min-height: 16px; }
      .auth-foot { margin-top: 8px; font-size: 11px; color: #9aa0a6; text-align: center; }
      .auth-foot a { color:#9aa0a6; text-decoration: underline; }
      .spinner { width: 18px; height: 18px; border-radius: 50%; border: 2px solid #eaeaea; border-top-color: transparent; animation: spin 0.9s linear infinite; display:inline-block; vertical-align: middle; }
      @keyframes spin { to { transform: rotate(360deg); } }
      noscript { display:block; padding:1rem; text-align:center; }
      #error-panel { max-width: 780px; margin: 24px auto; background:#1a1a1a; border:1px solid #2a2a2a; border-radius:12px; padding:16px; display:none; }
      #error-panel h3 { margin:0 0 8px; font-size:16px; }
      #error-panel pre { white-space: pre-wrap; word-break: break-word; margin:0; font-size:12px; color:#f6d6d6; }
    </style>

    <script type="module">
      // ---------- SETTINGS ----------
      const USER_PLACEHOLDER = "test";
      // sha256("test:Test-Arch-25")
      const HASH = "12fedae2fc63f71b5f12fea48146bf87f21fd8d83fd23f346a6c9362aa3e535e";
      const STORAGE_KEY = "siteAuth";
      const BYPASS_HOSTS = ["localhost", "127.0.0.1"];
      // -------------------------------

      // Optional quick logout: append ?logout=1
      if (new URLSearchParams(location.search).get("logout") === "1") {
        try { sessionStorage.removeItem(STORAGE_KEY); } catch(_) {}
      }

      const authed = sessionStorage.getItem(STORAGE_KEY) === "ok";
      const isBypass = BYPASS_HOSTS.includes(location.hostname);

      // Mount overlay immediately (so there is always something visible)
      mountOverlay();

      if (authed || isBypass) {
        setUnlocking(true);
        bootApp().then(() => {
          removeOverlay();
        }).catch(showFatal);
      } else {
        showGate();
      }

      // ----- Overlay + states -----
      function mountOverlay() {
        if (document.getElementById("auth-overlay")) return;
        const ov = document.createElement("div");
        ov.id = "auth-overlay";
        ov.innerHTML = `
          <div id="auth-card" role="dialog" aria-modal="true" aria-labelledby="auth-title">
            <h2 id="auth-title">Private Preview</h2>
            <p id="auth-desc">Enter access credentials to continue.</p>
            <form id="auth-form" class="auth-row" autocomplete="off" style="display:none">
              <input id="au" class="auth-input" placeholder="Username" value="${USER_PLACEHOLDER}" spellcheck="false" />
              <input id="ap" class="auth-input" type="password" placeholder="Password" />
              <button id="ab" class="auth-btn" type="submit">Enter</button>
              <div id="ae" class="auth-err"></div>
              <div class="auth-foot">Temporary & session‑based. <a href="?logout=1">Logout</a></div>
            </form>
            <div id="unlocking" style="display:none"><span class="spinner"></span> Unlocking…</div>
          </div>`;
        const add = () => { document.body.appendChild(ov); ov.style.display = "flex"; };
        (document.readyState === "loading") ? document.addEventListener("DOMContentLoaded", add, { once:true }) : add();
      }

      function showGate() {
        setUnlocking(false);
        const form = document.getElementById("auth-form");
        form.style.display = "grid";
        document.getElementById("ap").focus();

        document.addEventListener("submit", (ev) => {
          if (ev.target && ev.target.id === "auth-form") {
            ev.preventDefault();
            handleAuth();
          }
        });
      }

      function setUnlocking(isOn) {
        const form = document.getElementById("auth-form");
        const u = document.getElementById("unlocking");
        if (!form || !u) return;
        form.style.display = isOn ? "none" : "grid";
        u.style.display = isOn ? "block" : "none";
        const desc = document.getElementById("auth-desc");
        if (desc) desc.textContent = isOn ? "Loading application…" : "Enter access credentials to continue.";
      }

      function removeOverlay() {
        const ov = document.getElementById("auth-overlay");
        if (ov) ov.remove();
      }

      async function handleAuth() {
        const u = document.getElementById("au").value.trim();
        const p = document.getElementById("ap").value;
        const btn = document.getElementById("ab");
        const err = document.getElementById("ae");
        err.textContent = ""; btn.disabled = true;
        try {
          const digest = await sha256Hex(`${u}:${p}`);
          if (digest === HASH || (digest.startsWith("PLAIN:") && `${u}:${p}` === "test:Test-Arch-25")) {
            try { sessionStorage.setItem(STORAGE_KEY, "ok"); } catch(_) {}
            setUnlocking(true);
            await bootApp();
            removeOverlay();
            return;
          }
          err.textContent = "Incorrect username or password.";
        } catch (e) {
          showFatal(e);
        } finally {
          btn.disabled = false;
          const pw = document.getElementById("ap"); pw.value = ""; pw.focus();
        }
      }

      async function sha256Hex(s) {
        if (crypto && crypto.subtle) {
          const enc = new TextEncoder().encode(s);
          const buf = await crypto.subtle.digest("SHA-256", enc);
          return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
        }
        return "PLAIN:" + s; // legacy fallback
      }

      // ----- Boot your app (robust imports + error surfacing) -----
      async function bootApp() {
        try {
          const ReactMod = await import("https://esm.sh/react@18");
          const DOMMod = await import("https://esm.sh/react-dom@18/client");
          const AppMod = await import("/app.jsx");

          const React = ReactMod.default || ReactMod;
          const createRoot = DOMMod.createRoot || (DOMMod.default && DOMMod.default.createRoot);
          if (typeof createRoot !== "function") throw new Error("Unable to load ReactDOM.createRoot from ESM.");

          const App = AppMod.default || AppMod.App || AppMod;
          const rootEl = document.getElementById("root");
          if (!rootEl) throw new Error("Missing #root element.");

          const root = createRoot(rootEl);
          root.render(React.createElement(App));
        } catch (e) {
          throw enhance(e);
        }
      }

      function enhance(e) {
        // Add a hint if /app.jsx 404s or MIME/type issues occur
        const msg = String(e && e.message || e);
        if (msg.includes("Failed to fetch") || msg.includes("Loading module") || msg.includes("mime")) {
          e.message = msg + " — Check that /app.jsx exists at site root and is served with correct MIME (application/javascript).";
        }
        return e;
      }

      function showFatal(err) {
        console.error(err);
        // Keep overlay up but switch into an error panel below the app root
        const panel = document.getElementById("error-panel");
        if (panel) {
          panel.style.display = "block";
          panel.querySelector("pre").textContent = (err && err.stack) ? err.stack : String(err);
        }
        const desc = document.getElementById("auth-desc");
        if (desc) desc.textContent = "An error occurred while loading the app.";
        setUnlocking(false);
        const ae = document.getElementById("ae");
        if (ae) ae.textContent = "Load error. See details below.";
      }
    </script>
    <!-- =================== /TEMP PASSWORD GATE =================== -->
  </head>
  <body>
    <noscript>JavaScript is required to view this preview.</noscript>
    <div id="root"></div>

    <!-- Visible only if something fails; helps avoid a plain black screen -->
    <div id="error-panel">
      <h3>App load error</h3>
      <pre></pre>
    </div>
  </body>
</html>
